#!/bin/sh
# shellcheck shell=sh
# shellcheck enable=check-extra-masked-returns,deprecate-which,quote-safe-variables,check-unassigned-uppercase

SESSION_PATH=""
SESSION_NAME=""

if command -v fd >/dev/null 2>&1 && command -v fzf >/dev/null 2>&1; then
    dir="$HOME"
    temp_file=$(mktemp)

    while true; do
        cd "$dir" || exit 1
        n_paths=$(echo "$dir" | tr '/' '\n' | grep -c .)
        nth=$((n_paths + 2))

        selection=$(
            fd \
                -a \
                -L \
                -E node_modules \
                -E target \
                -E '_*' \
                -E 'venv' \
                --max-depth 3 \
                --type d \
                --type l \
                . 2>/dev/null |
                fzf \
                    --padding 1 \
                    -d'/' \
                    --with-nth="$nth".. \
                    --scheme=path \
                    --bind="enter:execute(echo 'navigate' > '$temp_file')+accept" \
                    --bind="ctrl-o:execute(echo 'select' > '$temp_file')+accept" \
                    --bind="ctrl-h:execute(echo 'home' > '$temp_file')+accept" \
                    --bind="ctrl-j:execute(echo 'back' > '$temp_file')+accept" \
                    --header="Enter: navigate | Ctrl+O: select | Ctrl+J: go back | Ctrl+H: pick home" \
                    --prompt="$dir: "
        )

        if [ -n "$selection" ]; then
            if [ -f "$temp_file" ]; then
                action=$(head -1 "$temp_file")
                rm -f "$temp_file"
                case "$action" in
                "navigate")
                    dir="$selection"
                    continue
                    ;;
                "back")
                    dir="$(realpath -- "$dir"/..)"
                    continue
                    ;;
                "select")
                    SESSION_PATH="$selection"
                    SESSION_NAME=$(basename -- "$selection")
                    break
                    ;;
                "home")
                    SESSION_PATH="$HOME"
                    SESSION_NAME="$$"
                    break
                    ;;
                esac
            fi
        else
            tmux display-message "No directory selected, exiting."
            exit 1
        fi
    done
else
    tmux display-message "Warning: fd or fzf not found."
    exit 1
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    tmux display-message "Session with name '$SESSION_NAME' already exist."
else
    tmux new-session -s "$SESSION_NAME" -c "$SESSION_PATH" -d
fi

exec tmux switch-client -t "$SESSION_NAME"
