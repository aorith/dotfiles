#!/bin/sh
# shellcheck shell=sh
# shellcheck enable=check-extra-masked-returns,deprecate-which,quote-safe-variables,check-unassigned-uppercase

cd "$1" || exit 1

PATH="/opt/homebrew/bin:$HOME/.nix-profile/bin:$PATH"

session_path=""
session_name=""

if command -v fd >/dev/null 2>&1 && command -v fzf >/dev/null 2>&1; then
    dir="$HOME/githome"
    temp_file=$(mktemp)

    while true; do
        cd "$dir" || exit 1
        n_paths=$(echo "$dir" | tr '/' '\n' | grep -c .)
        nth=$((n_paths + 2))

        selection=$(
            fd \
                -a \
                -L \
                -E node_modules \
                -E target \
                -E '_*' \
                -E 'venv' \
                --max-depth 3 \
                --type d \
                --type l \
                . 2>/dev/null |
                fzf \
                    --tmux \
                    --padding 1 \
                    -d'/' \
                    --with-nth="$nth".. \
                    --scheme=path \
                    --bind="enter:execute(echo 'select' > '$temp_file')+accept" \
                    --bind="ctrl-i:execute(echo 'navigate' > '$temp_file')+accept" \
                    --bind="ctrl-o:execute(echo 'back' > '$temp_file')+accept" \
                    --bind="ctrl-t:execute(echo 'home' > '$temp_file')+accept" \
                    --header="Enter: select | Ctrl+I: navigate | Ctrl+O: go back | Ctrl+T: pick home" \
                    --prompt="$dir: "
        )

        if [ -n "$selection" ]; then
            if [ -f "$temp_file" ]; then
                action=$(head -1 "$temp_file")
                rm -f "$temp_file"
                case "$action" in
                "navigate")
                    dir="$selection"
                    continue
                    ;;
                "back")
                    dir="$(realpath -- "$dir"/..)"
                    continue
                    ;;
                "select")
                    session_path="$selection"
                    session_name=$(basename -- "$selection")
                    break
                    ;;
                "home")
                    session_path="$HOME"
                    session_name="$$"
                    break
                    ;;
                esac
            fi
        else
            tmux display-message "No directory selected, exiting."
            exit 0
        fi
    done
else
    tmux display-message "Warning: fd or fzf not found."
    exit 0
fi

if tmux has-session -t "$session_name" 2>/dev/null; then
    tmux display-message "Session with name '$session_name' already exist."
else
    tmux new-session -s "$session_name" -c "$session_path" -d
fi

exec tmux switch-client -t "$session_name"
