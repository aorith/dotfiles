#!/bin/sh
# shellcheck shell=sh
# shellcheck enable=check-extra-masked-returns,deprecate-which,quote-safe-variables,check-unassigned-uppercase

CURRENT_PATH="$PWD"

SESSION_PATH=""
SESSION_NAME=""

if command -v fd >/dev/null 2>&1 && command -v fzf >/dev/null 2>&1; then
    n_paths=$(echo "$PWD" | tr '/' '\n' | grep -c .)
    nth=$((n_paths + 2))

    SELECTION=$(fd \
        -a \
        -L \
        -E node_modules \
        -E target \
        -E '_*' \
        -E 'venv' \
        --max-depth 12 \
        --type d \
        --type l \
        . 2>/dev/null | fzf --padding 1 -d'/' --with-nth="$nth".. --scheme=path --prompt="Session path: ")
    if [ -n "$SELECTION" ]; then
        SESSION_PATH="$SELECTION"
        SESSION_NAME=$(basename -- "$SELECTION")
    else
        tmux display-message "No directory selected, exiting."
        exit 1
    fi
else
    tmux display-message "Warning: fd or fzf not found. Using base directory as session path."
    SESSION_PATH="$CURRENT_PATH"

    printf "Enter session name: "
    read -r SESSION_NAME
    if [ -z "$SESSION_NAME" ]; then
        tmux display-message "No session name provided, exiting."
        exit 1
    fi
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    tmux display-message "Session with name '$SESSION_NAME' already exist."
else
    tmux new-session -s "$SESSION_NAME" -c "$SESSION_PATH" -d
fi

exec tmux switch-client -t "$SESSION_NAME"
