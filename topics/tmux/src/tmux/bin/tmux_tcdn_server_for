#!/usr/bin/env bash
PATH="${PATH}:/opt/homebrew/bin:${HOME}/Syncthing/SYNC_STUFF/githome/private_dotfiles/topics/scripts-private/bin"

# calling this does an initial update if required
tes-ip-or-node "dummy-value" >/dev/null

re="$(xargs <~/.local/state/.tcdn-server-map | tr ' ' '\n' | paste -sd'|')"

out="$(
    rg -o "(${re})" | sort | uniq | while read -r line; do
        tes-ip-or-node "$line"
    done | sort | uniq | column -t -o' '
)"

if [[ -n "$out" ]]; then
    choice="$(fzf --reverse <<<"$out")"
    [[ -n "$choice" ]] || exit
    choice2="$(tr ' ' '\n' <<<"$choice" | sort | fzf --reverse) "
    [[ -n "$choice2" ]] || exit
    echo -n "$choice2" | pbcopy
else
    tmux display-message "No server/IP found."
fi
