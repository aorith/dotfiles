#!/usr/bin/env bash

SCRIPTPATH="$(
    cd -- "$(dirname "$0")" >/dev/null 2>&1 || exit 1
    pwd -P
)/$(basename -- "$0")"

switch() {
    local sessions
    local session
    local query
    local sess_arr
    local retval

    local fzf_command=(fzf --tmux --exit-0 --print-query --reverse)

    sessions="$(tmux list-sessions -F "#{session_name}" | grep -v '_popup_' | "${fzf_command[@]}")"
    retval=$?

    IFS=$'\n' read -rd '' -a sess_arr <<<"$sessions"
    session="${sess_arr[1]}"
    query="${sess_arr[0]}"

    if ((retval == 0)); then
        tmux switch-client -t "$session"
    elif ((retval == 1)); then
        tmux command-prompt -b -p "Press enter to create and go to [$query] session" \
            "run '\"$SCRIPTPATH\" \"$query\" \"%1\"'"
    fi
}

create() {
    tmux new-session -d -s "$1"
    tmux switch-client -t "$1"
}

if [[ -n "$1" ]]; then
    create "$1"
else
    switch
fi
