# vim: ft=tmux

bind 'C-b' send-prefix

# Clear copy-mode (use copy-mode-vi)
unbind -T copy-mode -a

bind -N 'Custom: List key bindings' '?' display-popup -w95% -h95% -E "tmux list-keys | nvim --cmd 'set ft=tmux' -"

bind -N 'Reload config' 'r' {
    source-file ~/.config/tmux/tmux.conf
    display 'Config reloaded'
}

# Default binding asks for confirmation
bind -N 'Kill pane' 'x' kill-pane

bind -N 'Clear both screen and tmux history buffer' -n 'C-l' {
    send-keys 'C-l'
    if-shell '[[ ! $(tmux display-message -p "#W") =~ vim ]]' {
      run-shell -d 0.1
      clear-history
    }
}

# Sessions
bind -N 'New session on path' 'C' {
  display-popup -w 80% -h 80% -d '#{pane_current_path}' -E "~/.config/tmux/bin/tmux_new_session_on_path"
}
bind -N 'Choose-Session' -n 'M-(' choose-tree -Zs -f '#{?#{m:_popup_*,#S},0,1}' -O name
bind -N 'Set pane cwd as session cwd' 'p' {
  display-message 'Session path set to "#{pane_current_path}"'
  attach-session -t . -c '#{pane_current_path}'
}

# Rename window/session
bind -N 'Rename window'  'W'  command-prompt -I "#W" "rename-window -- '%%'"
bind -N 'Rename session' 'S' command-prompt -I "#S" "rename-session -- '%%'"

# Move windows
bind < swap-window -d -t -1
bind > swap-window -d -t +1

# Select panes
bind -N 'Select left pane'   'h' select-pane -L
bind -N 'Select bottom pane' 'j' select-pane -D
bind -N 'Select top pane'    'k' select-pane -U
bind -N 'Select right pane'  'l' select-pane -R

# Move panes
bind -N 'Swap pane left'   'H' swap-pane -s '{left-of}'
bind -N 'Swap pane down'   'J' swap-pane -s '{down-of}'
bind -N 'Swap pane up'     'K' swap-pane -s '{up-of}'
bind -N 'Swap pane right'  'L' swap-pane -s '{right-of}'

# Resize panes
bind -N 'Resize left'      'C-h' resize-pane -L 1
bind -N 'Resize down'      'C-j' resize-pane -D 1
bind -N 'Resize up'        'C-k' resize-pane -U 1
bind -N 'Resize right'     'C-l' resize-pane -R 1

# Split panes
unbind '"'
unbind '%'
bind -N 'Split horizontally' '|' split-window -h -c '#{pane_current_path}'
bind -N 'Split vertically' '-' split-window -v -c '#{pane_current_path}'

bind -N 'Toggle pane synchronization' 's' {
  set synchronize-panes
  display 'synchronize-panes #{?synchronize-panes,on,off}'
}

bind -T copy-mode-vi 'Escape' {
  if -F '#{selection_active}' {
    send-keys -X clear-selection
  } {
    send-keys -X cancel
  }
}
bind -N 'Begin selection' -T copy-mode-vi 'v' send-keys -X begin-selection
bind -N 'Rectangle toggle' -T copy-mode-vi 'C-v' send-keys -X rectangle-toggle
bind -N 'Rectangle toggle' -T copy-mode-vi 'r' send-keys -X rectangle-toggle
bind -N 'Copy and cancel' -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel
bind -N 'Copy and cancel' -T copy-mode-vi 'c' send-keys -X copy-pipe
bind -N 'Copy and cancel' -T copy-mode-vi 'Enter' send-keys -X copy-pipe-and-cancel
bind -N 'Copy and paste selection' -T copy-mode-vi 'C-p' send-keys -X pipe-and-cancel 'xargs tmux send-keys -l'
bind -N 'Cancel copy mode' -T copy-mode-vi 'q' send-keys -X cancel
bind -N 'Cancel copy mode' -T copy-mode-vi 'C-c'  send-keys -X cancel
bind -N 'PageUp' -T copy-mode-vi 'K'  send-keys -X page-up
bind -N 'PageDown' -T copy-mode-vi 'J'  send-keys -X page-down

bind -T copy-mode-vi '/' command-prompt -i -I "#{pane_search_string}" -p "(search down)" { send -X search-forward-incremental '%%' }
bind -T copy-mode-vi '?' command-prompt -i -I "#{pane_search_string}" -p "(search up)" { send -X search-backward-incremental '%%' }

bind -N 'Search' -n 'M-)' {
  copy-mode
  command-prompt -i -p "(search up)" { send -X search-backward-incremental '%%' }
}
bind -N 'Enter copy mode' -n 'M-o' copy-mode

bind -N 'Open selected file in nvim' -T copy-mode-vi 'E' send-keys -X pipe-and-cancel 'xargs -I% tmux send-keys nvim Space % Enter'
bind -N 'Info for selection' -T copy-mode-vi 'i' {
  send-keys -X pipe-no-clear "xargs -I% ~/.config/tmux/bin/tmux_info '#{pane_current_path}' %"
}

bind -N "Search patterns" 'u' {
  copy-mode
  #                       -- git hash -----|-------- Urls -----------------------------
  send -X search-backward "([A-Fa-f0-9]{8,}|https?://[[:alnum:]?=%/_.:,;~@!#$&()*+-]*)"
}

bind -N 'Open buffer in nvim' 'e' {
  capture-pane -S -
  display-popup -w '100%' -h '100%' -B -E 'tmux show-buffer | ~/.config/tmux/bin/tmux_nvim_scrollback'
}

#bind -N 'Switch theme' 't' display-popup -w80% -h90% -E "bash -lic '$HOME/.config/alacritty/bin/switch-theme.sh'"
bind -N 'Switch theme' 't' run-shell "~/.config/ghostty/bin/switch-theme.sh"
#bind -N 'Switch theme' 't' run-shell "~/.config/kitty/bin/switch-theme"

# Popup window
bind -N 'Popup' -n 'M-p' {
  display-popup -w '80%' -h '80%' -b rounded -E "~/.config/tmux/bin/tmux_popup '#{pane_current_path}'"
}

# Bind keys to the popup table, must be unprefixed keys if I want to use the same keys in both root and popup
bind -T popup -N 'Choose-Session' -n 'M-(' choose-tree -Zs -f '#{?#{m:_popup_*,#S},0,1}' -O name
bind -T popup -N 'Detach Popup' -n 'M-p' detach
bind -T popup -N 'Enter copy mode' -n 'M-o' copy-mode
bind -T popup -N 'Search' -n 'M-)' {
  copy-mode
  command-prompt -i -p "(search up)" { send -X search-backward-incremental '%%' }
}


# Mouse bindings
# Disable mouse scroll on status bar so it does not switch windows
unbind -n 'WheelUpStatus'
unbind -n 'WheelDownStatus'

# Keep the selection active on mouse-drag
unbind -T copy-mode-vi MouseDragEnd1Pane
bind -T copy-mode-vi MouseDown1Pane select-pane\; send -X clear-selection

# Bind WheelUpPane so the popup table can enable copy-mode when scrolling up
bind -T popup 'WheelUpPane' {
  if -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" {
    send-keys -M
  } {
    if -F '#{alternate_on}' {
      send-keys -N 3 Up
    } {
      copy-mode -e
    }
  }
}

