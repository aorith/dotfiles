# ~/.bashrc
# shellcheck disable=SC1090,SC2155,SC1091

set -a
for f in ~/.config/environment.d/*.conf; do
    . "$f"
done
set +a

shopt -s checkjobs checkwinsize histappend cmdhist globstar autocd 2>/dev/null
set -o notify # notify completed background jobs immediately

export HISTFILE="${XDG_DATA_HOME:-$HOME/.local/share}/.bash_history"
export HISTCONTROL="erasedups:ignoreboth"
export HISTSIZE=10000
export HISTTIMEFORMAT=$(echo -e '\033[0;34m%h/%d %H:%M:%S\033[0m ')
export HISTIGNORE="&:[ ]*:exit:ls:bg:fg:history:clear"

# Prompt
export PROMPT_DIRTRIM=8
export PS4='+ ${BASH_SOURCE:-}:${LINENO:-}: ${FUNCNAME[0]:-}() [${?:-}] → '

. ~/githome/dotfiles/utils/functions.sh
. ~/githome/dotfiles/topics/shell/etc/common/exports.sh
. ~/githome/dotfiles/topics/shell/etc/common/aliases.sh
. ~/githome/dotfiles/topics/shell/src/bash/functions.sh
. ~/githome/dotfiles/topics/shell/src/bash/completion.sh

# Extra
if [[ -e "$PRIVATE_DOTFILES" ]]; then
    . "$PRIVATE_DOTFILES/topics/tcdn/env/all/bash/04_aliases"
fi

# Containers
if [[ -z "$CONTAINER_ID" ]] && [[ -e /run/.containerenv ]]; then
    export CONTAINER_ID=$(awk -F '=' '/^name=/ {print $2}' /run/.containerenv | tr -d '"')
fi

# Homebrew
if [[ -e /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
    . /opt/homebrew/etc/profile.d/bash_completion.sh
fi

# FZF
if [[ -e /usr/share/fzf/shell/key-bindings.bash ]]; then
    . /usr/share/fzf/shell/key-bindings.bash
fi

# Nix (non NixOS)
if [[ ! -e /etc/nixos ]]; then
    if [[ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]]; then
        . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
    fi
    if [[ -e ~/.nix-profile/etc/profile.d/hm-session-vars.sh ]]; then
        . ~/.nix-profile/etc/profile.d/hm-session-vars.sh
    fi
fi

# Paths
for p in \
    "$HOME/Syncthing/SYNC_STUFF/githome/private_dotfiles/topics/tcdn/bin" \
    "$HOME/Syncthing/SYNC_STUFF/githome/private_dotfiles/topics/scripts-private/bin" \
    "$HOME/.local/bin" \
    "$HOME/.local/go/bin" \
    "$HOME/.local/share/nvim/mason/bin"; do
    prepend_to_path "$p" PATH
done

case $OSTYPE in
darwin*)
    for p in \
        "$HOME/.docker/bin" \
        "/opt/homebrew/opt/coreutils/libexec/gnubin" \
        "/opt/homebrew/opt/findutils/libexec/gnubin" \
        "/opt/homebrew/opt/diffutils/bin" \
        "/opt/homebrew/opt/grep/libexec/gnubin" \
        "/opt/homebrew/opt/gnu-sed/libexec/gnubin" \
        "/opt/homebrew/opt/curl/bin" \
        "/opt/homebrew/opt/util-linux/bin" \
        "/opt/homebrew/opt/openssl@3/bin" \
        "/opt/homebrew/opt/gnu-tar/libexec/gnubin"; do
        prepend_to_path "$p" PATH
    done
    ;;
esac

# Optionally use starship
# if type starship >/dev/null 2>&1; then
#     set_win_title() {
#         echo -ne "\033]0;$USER@$HOSTNAME $PWD\007"
#     }
#     starship_precmd_user_func="set_win_title"
#     eval "$(starship init bash)"
# else
#     . "${DOTFILES}"/topics/shell/src/bash/etc/prompt.sh
# fi
. "${DOTFILES}"/topics/shell/src/bash/etc/prompt.sh
