#!/bin/sh
# shellcheck shell=sh
# shellcheck enable=check-extra-masked-returns,deprecate-which,quote-safe-variables,check-unassigned-uppercase

PATH="/opt/homebrew/bin:$HOME/.nix-profile/bin:$PATH"
SESSION_PATH=""

if command -v fd >/dev/null 2>&1 && command -v fzf >/dev/null 2>&1; then
    dir="$HOME/githome"
    temp_file=$(mktemp)

    while true; do
        cd "$dir" || exit 1
        n_paths=$(echo "$dir" | tr '/' '\n' | grep -c .)
        nth=$((n_paths + 2))

        selection=$(
            fd \
                -a \
                -L \
                -E node_modules \
                -E target \
                -E '_*' \
                -E 'venv' \
                --max-depth 3 \
                --type d \
                --type l \
                . 2>/dev/null |
                fzf \
                    --padding 1 \
                    -d'/' \
                    --with-nth="$nth".. \
                    --scheme=path \
                    --bind="enter:execute(echo 'select' > '$temp_file')+accept" \
                    --bind="ctrl-i:execute(echo 'navigate' > '$temp_file')+accept" \
                    --bind="ctrl-o:execute(echo 'back' > '$temp_file')+accept" \
                    --bind="ctrl-h:execute(echo 'home' > '$temp_file')+accept" \
                    --header="Enter: select | Ctrl+I: navigate | Ctrl+O: go back | Ctrl+H: pick home" \
                    --prompt="$dir: "
        )

        if [ -n "$selection" ]; then
            if [ -f "$temp_file" ]; then
                action=$(head -1 "$temp_file")
                rm -f "$temp_file"
                case "$action" in
                "navigate")
                    dir="$selection"
                    continue
                    ;;
                "back")
                    dir="$(realpath -- "$dir"/..)"
                    continue
                    ;;
                "select")
                    SESSION_PATH="$selection"
                    break
                    ;;
                "home")
                    SESSION_PATH="$HOME"
                    break
                    ;;
                esac
            fi
        else
            tmux display-message "No directory selected, exiting."
            exit 1
        fi
    done
else
    kitten @ kitten notify "Warning: fd or fzf not found."
    exit 1
fi

echo "Creating session at $SESSION_PATH"
export _KITTY_PATH="$SESSION_PATH"
cd "$SESSION_PATH" && "$SHELL"
